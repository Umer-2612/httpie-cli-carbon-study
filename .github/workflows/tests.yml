# ============================================================
# C1 — Baseline: Tests Workflow with Eco-CI Instrumentation
# Branch: experiment/c1-baseline
# ============================================================
name: Tests

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
      - 'experiment/**'
    paths:
      - .github/workflows/tests.yml
      - httpie/**/*.py
      - setup.*
      - tests/**/*.py
  pull_request:
    paths:
      - .github/workflows/tests.yml
      - httpie/**/*.py
      - setup.*
      - tests/**/*.py
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger (e.g., research run C1)'
        required: false
        default: 'Manual research run'

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version:
          - '3.12'
          - '3.11'
          - '3.10'
    runs-on: ${{ matrix.os }}

    steps:
      # ----------------------------------------------------------
      # Eco-CI: start total measurement for this job
      # ----------------------------------------------------------
      - name: Eco-CI Start Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          continue-on-error: true

      # ----------------------------------------------------------
      # Stage 1: Checkout
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Eco-CI — checkout measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'checkout'
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 2: Python setup + dependency installation
      # ----------------------------------------------------------
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies (Linux/Mac)
        if: matrix.os != 'windows-latest'
        run: make install

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip install --upgrade '.[dev]'

      - name: Eco-CI — dependency installation measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'dependency-installation'
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 3: Test execution
      # ----------------------------------------------------------
      - name: Run tests (Linux/Mac)
        if: matrix.os != 'windows-latest'
        run: make test
        env:
          HTTPIE_TEST_WITH_PYOPENSSL: ${{ matrix.pyopenssl || 0 }}

      - name: Run tests (Windows)
        if: matrix.os == 'windows-latest'
        run: python -m pytest --verbose ./httpie ./tests
        env:
          HTTPIE_TEST_WITH_PYOPENSSL: ${{ matrix.pyopenssl || 0 }}

      - name: Eco-CI — test execution measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'test-execution'
        continue-on-error: true

      # ----------------------------------------------------------
      # Eco-CI: display final results and upload JSON artifact
      # ----------------------------------------------------------
      - name: Eco-CI — display results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          json-output: true
        continue-on-error: true

      - name: Upload Eco-CI results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eco-ci-results-tests-py${{ matrix.python-version }}-${{ matrix.os }}
          path: /tmp/eco-ci/
          retention-days: 30
