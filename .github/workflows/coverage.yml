# ============================================================
# C1 — Baseline: Coverage Workflow with Eco-CI Instrumentation
# Branch: experiment/c1-baseline
# ============================================================
name: Coverage

on:
  push:
    branches:
      - master
      - 'experiment/**'
    paths:
      - .github/workflows/coverage.yml
      - httpie/**/*.py
      - setup.*
      - tests/**/*.py
  pull_request:
    paths:
      - .github/workflows/coverage.yml
      - httpie/**/*.py
      - setup.*
      - tests/**/*.py
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger (e.g., research run C1)'
        required: false
        default: 'Manual research run'

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------
      # Eco-CI: start total measurement for this job
      # ----------------------------------------------------------
      - name: Eco-CI Start Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 1: Checkout
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Eco-CI — checkout measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'checkout'
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 2: Python setup + dependency installation
      # ----------------------------------------------------------
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: make install

      - name: Eco-CI — dependency installation measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'dependency-installation'
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 3: Coverage run
      # ----------------------------------------------------------
      - name: Run tests with coverage
        run: make test-cover

      - name: Eco-CI — coverage measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'coverage'
        continue-on-error: true

      # ----------------------------------------------------------
      # Stage 4: Coverage upload + distribution test
      # ----------------------------------------------------------
      - name: Upload to Codecov
        run: make codecov-upload
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_REPO_TOKEN }}
        continue-on-error: true

      - name: Test distribution build
        run: make test-dist

      - name: Eco-CI — post-coverage measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: 'dist-test'
        continue-on-error: true

      # ----------------------------------------------------------
      # Eco-CI: display final results and upload JSON artifact
      # ----------------------------------------------------------
      - name: Eco-CI — display results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          json-output: true
        continue-on-error: true

      - name: Upload Eco-CI results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eco-ci-results-coverage
          path: /tmp/eco-ci/
          retention-days: 30
